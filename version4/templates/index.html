<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Chatbot</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #6a5acd;
        --secondary-color: #e6e6fa;
        --text-color: #333;
        --light-text: #6e6e80;
        --border-color: #e0e0e0;
        --hover-color: #7b68ee;
        --background-color: #f8f8f8;
        --message-bg-user: #f0f4ff;
        --message-bg-bot: #ffffff;
        --send-button: #6a5acd;
        --sidebar-width: 320px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
      }

      body {
        background-color: var(--background-color);
        color: var(--text-color);
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      /* Sidebar Styles */
      .sidebar {
        width: var(--sidebar-width);
        background-color: white;
        border-right: 1px solid var(--border-color);
        height: 100vh;
        overflow-y: auto;
        position: relative;
        z-index: 10;
        transition: transform 0.3s ease;
      }

      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .sidebar-header h2 {
        font-size: 1.25rem;
        color: var(--primary-color);
      }

      .mobile-toggle {
        display: none;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--primary-color);
      }

      .sidebar-content {
        padding: 20px;
      }

      .url-form {
        margin-bottom: 20px;
      }

      .url-form label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-color);
      }

      .url-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 10px;
        font-size: 1rem;
      }

      .url-input:focus {
        outline: none;
        border-color: var(--primary-color);
      }

      .submit-btn {
        width: 100%;
        padding: 12px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: background-color 0.2s;
      }

      .submit-btn:hover {
        background-color: var(--hover-color);
      }

      .submit-btn:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }

      .session-info {
        margin-top: 30px;
        padding: 15px;
        background-color: var(--secondary-color);
        border-radius: 8px;
        display: none;
      }

      .session-info h3 {
        margin-bottom: 10px;
        font-size: 1rem;
      }

      .session-info p {
        margin-bottom: 8px;
        font-size: 0.9rem;
        color: var(--light-text);
      }

      .clear-btn {
        width: 100%;
        padding: 10px;
        margin-top: 15px;
        background-color: white;
        color: var(--primary-color);
        border: 1px solid var(--primary-color);
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
        display: none;
      }

      .clear-btn:hover {
        background-color: var(--secondary-color);
      }

      /* Main Chat Area */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
        position: relative;
      }

      .chat-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        background-color: white;
        display: flex;
        align-items: center;
      }

      .menu-toggle {
        display: none;
        background: none;
        border: none;
        font-size: 1.5rem;
        margin-right: 15px;
        cursor: pointer;
        color: var(--primary-color);
      }

      .chat-title {
        font-size: 1.2rem;
        color: var(--text-color);
      }

      .chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }

      .message-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .message {
        max-width: 90%;
        padding: 15px;
        border-radius: 12px;
        font-size: 1rem;
        line-height: 1.5;
      }

      .user-message {
        align-self: flex-end;
        background-color: var(--message-bg-user);
        border: 1px solid #d1dcff;
      }

      .bot-message {
        align-self: flex-start;
        background-color: var(--message-bg-bot);
        border: 1px solid var(--border-color);
      }

      .welcome-container {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 20px;
      }

      .welcome-icon {
        font-size: 3rem;
        color: var(--primary-color);
        margin-bottom: 20px;
      }

      .welcome-text {
        font-size: 1.5rem;
        margin-bottom: 10px;
        color: var(--text-color);
      }

      .welcome-subtext {
        font-size: 1rem;
        color: var(--light-text);
        max-width: 500px;
      }

      .input-area {
        padding: 20px;
        border-top: 1px solid var(--border-color);
        background-color: white;
        display: flex;
        align-items: center;
      }

      .message-input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid var(--border-color);
        border-radius: 24px;
        font-size: 1rem;
        resize: none;
        min-height: 24px;
        max-height: 150px;
        overflow-y: auto;
      }

      .message-input:focus {
        outline: none;
        border-color: var(--primary-color);
      }

      .send-btn {
        background-color: var(--send-button);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        margin-left: 10px;
        transition: background-color 0.2s;
      }

      .send-btn:hover {
        background-color: var(--hover-color);
      }

      .send-btn:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }

      .loader {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none;
      }

      /* Markdown styles */
      .bot-message ul,
      .bot-message ol {
        margin-left: 20px;
        margin-top: 10px;
        margin-bottom: 10px;
      }

      .bot-message p {
        margin-bottom: 10px;
      }

      .bot-message h1,
      .bot-message h2,
      .bot-message h3 {
        margin-top: 15px;
        margin-bottom: 8px;
      }

      .bot-message code {
        background-color: #f1f1f1;
        padding: 2px 4px;
        border-radius: 4px;
        font-family: monospace;
      }

      .bot-message pre {
        background-color: #f1f1f1;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        margin: 10px 0;
      }

      /* Error toast */
      .error-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #f44336;
        color: white;
        padding: 15px 20px;
        border-radius: 5px;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        max-width: 400px;
      }

      .error-toast .close {
        margin-left: 15px;
        color: white;
        font-weight: bold;
        cursor: pointer;
      }

      /* Responsive Design */
      @media screen and (max-width: 768px) {
        .sidebar {
          position: fixed;
          top: 0;
          left: 0;
          transform: translateX(-100%);
          z-index: 1000;
          box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar.open {
          transform: translateX(0);
        }

        .mobile-toggle,
        .menu-toggle {
          display: block;
        }

        .message {
          max-width: 95%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar for URL input and session info -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>Content Chatbot</h2>
        <button class="mobile-toggle">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="sidebar-content">
        <form id="url-form" class="url-form">
          <label for="url-input">Enter a URL to analyze</label>
          <input
            type="url"
            id="url-input"
            class="url-input"
            placeholder="https://example.com"
            required
          />
          <button type="submit" id="submit-url" class="submit-btn">
            <span id="submit-text">Process URL</span>
            <span id="submit-loader" class="loader hidden"></span>
          </button>
        </form>

        <div id="session-info" class="session-info">
          <h3>Current Session</h3>
          <p><strong>Content Type:</strong> <span id="content-type">-</span></p>
          <p><strong>Title:</strong> <span id="content-title">-</span></p>
          <button id="clear-conversation" class="clear-btn">
            Clear Conversation
          </button>
        </div>
      </div>
    </div>

    <!-- Main content area for chat -->
    <div class="main-content">
      <div class="chat-header">
        <button class="menu-toggle">
          <i class="fas fa-bars"></i>
        </button>
        <h2 class="chat-title">Chat with Content</h2>
      </div>

      <div class="chat-container">
        <div id="welcome-screen" class="welcome-container">
          <div class="welcome-icon">
            <i class="fas fa-robot"></i>
          </div>
          <h2 class="welcome-text">Welcome to Content Chatbot</h2>
          <p class="welcome-subtext">
            Enter a URL in the sidebar to start analyzing content and chatting
            with it. I support YouTube videos, Wikipedia articles, and general
            webpages.
          </p>
        </div>

        <div id="message-container" class="message-container hidden"></div>
      </div>

      <div class="input-area">
        <textarea
          id="message-input"
          class="message-input"
          placeholder="Ask a question about the content..."
          disabled
        ></textarea>
        <button id="send-message" class="send-btn" disabled>
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // DOM Elements
        const urlForm = document.getElementById("url-form");
        const urlInput = document.getElementById("url-input");
        const submitBtn = document.getElementById("submit-url");
        const submitText = document.getElementById("submit-text");
        const submitLoader = document.getElementById("submit-loader");
        const messageInput = document.getElementById("message-input");
        const sendBtn = document.getElementById("send-message");
        const messageContainer = document.getElementById("message-container");
        const welcomeScreen = document.getElementById("welcome-screen");
        const sessionInfo = document.getElementById("session-info");
        const contentType = document.getElementById("content-type");
        const contentTitle = document.getElementById("content-title");
        const clearBtn = document.getElementById("clear-conversation");
        const sidebar = document.querySelector(".sidebar");
        const menuToggle = document.querySelector(".menu-toggle");
        const mobileToggle = document.querySelector(".mobile-toggle");

        // Current session
        let currentSessionId = null;

        // Create a function to show error toast
        function showError(message) {
          // Remove any existing error toast
          const existingToast = document.querySelector(".error-toast");
          if (existingToast) {
            existingToast.remove();
          }

          // Create new error toast
          const toast = document.createElement("div");
          toast.className = "error-toast";
          toast.innerHTML = `
                    <span>${message}</span>
                    <span class="close">&times;</span>
                `;

          document.body.appendChild(toast);

          // Add close button functionality
          const closeBtn = toast.querySelector(".close");
          closeBtn.addEventListener("click", function () {
            toast.remove();
          });

          // Auto remove after 5 seconds
          setTimeout(() => {
            if (document.body.contains(toast)) {
              toast.remove();
            }
          }, 5000);
        }

        // Handle URL submission
        urlForm.addEventListener("submit", async function (e) {
          e.preventDefault();

          const url = urlInput.value.trim();
          if (!url) return;

          // Show loading state
          submitBtn.disabled = true;
          submitText.classList.add("hidden");
          submitLoader.classList.remove("hidden");

          try {
            const response = await fetch("/api/process-url", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ url }),
            });

            let data;
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
              data = await response.json();
            } else {
              throw new Error(
                "Server returned non-JSON response: " + (await response.text())
              );
            }

            if (!response.ok) {
              throw new Error(data.error || "Failed to process URL");
            }

            // Update session info
            currentSessionId = data.session_id;
            contentType.textContent =
              data.url_type.charAt(0).toUpperCase() + data.url_type.slice(1);
            contentTitle.textContent = data.page_title;

            // Show session info and clear button
            sessionInfo.style.display = "block";
            clearBtn.style.display = "block";

            // Enable chat input
            messageInput.disabled = false;
            sendBtn.disabled = false;

            // Hide welcome screen, show message container
            welcomeScreen.classList.add("hidden");
            messageContainer.classList.remove("hidden");

            // Add initial bot message
            addMessage(
              "assistant",
              `I've analyzed the content from ${data.content_source}. Here's a summary:\n\n${data.summary}\n\nYou can now ask me questions about this content!`
            );

            // On mobile, close sidebar after successful URL processing
            if (window.innerWidth <= 768) {
              sidebar.classList.remove("open");
            }
          } catch (error) {
            console.error("Error:", error);
            showError(error.message);
          } finally {
            // Reset button state
            submitBtn.disabled = false;
            submitLoader.classList.add("hidden");
            submitText.classList.remove("hidden");
          }
        });

        // Handle sending messages
        sendBtn.addEventListener("click", sendMessage);
        messageInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

        // Auto-resize textarea
        messageInput.addEventListener("input", function () {
          this.style.height = "auto";
          this.style.height = this.scrollHeight + "px";
        });

        // Handle message sending
        async function sendMessage() {
          const message = messageInput.value.trim();
          if (!message || !currentSessionId) return;

          // Add user message to chat
          addMessage("user", message);

          // Clear input and reset height
          messageInput.value = "";
          messageInput.style.height = "auto";

          // Disable input while waiting for response
          messageInput.disabled = true;
          sendBtn.disabled = true;

          try {
            const response = await fetch("/api/ask", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                session_id: currentSessionId,
                question: message,
              }),
            });

            let data;
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
              data = await response.json();
            } else {
              throw new Error(
                "Server returned non-JSON response: " + (await response.text())
              );
            }

            if (!response.ok) {
              throw new Error(data.error || "Failed to get response");
            }

            // Add bot response to chat
            addMessage("assistant", data.answer);
          } catch (error) {
            console.error("Error:", error);
            addMessage("assistant", `Error: ${error.message}`);
          } finally {
            // Re-enable input
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();
          }
        }

        // Add message to chat
        function addMessage(role, content) {
          const messageElement = document.createElement("div");
          messageElement.className =
            role === "user" ? "message user-message" : "message bot-message";

          // Convert markdown-like content (basic formatting)
          const formattedContent = formatMessage(content);
          messageElement.innerHTML = formattedContent;

          messageContainer.appendChild(messageElement);

          // Scroll to bottom
          messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        // Format message with basic markdown
        function formatMessage(text) {
          // Convert URLs to links
          text = text.replace(
            /https?:\/\/\S+/g,
            (url) => `<a href="${url}" target="_blank">${url}</a>`
          );

          // Convert line breaks
          text = text.replace(/\n/g, "<br>");

          // Handle bold formatting
          text = text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");

          // Handle italic formatting
          text = text.replace(/\*(.*?)\*/g, "<em>$1</em>");

          // Handle code blocks
          text = text.replace(
            /```([\s\S]*?)```/g,
            "<pre><code>$1</code></pre>"
          );

          // Handle inline code
          text = text.replace(/`([^`]+)`/g, "<code>$1</code>");

          return text;
        }

        // Clear conversation
        clearBtn.addEventListener("click", async function () {
          if (!currentSessionId) return;

          try {
            const response = await fetch("/api/clear-conversation", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                session_id: currentSessionId,
              }),
            });

            let data;
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
              data = await response.json();
            } else {
              throw new Error("Server returned non-JSON response");
            }

            if (!response.ok) {
              throw new Error(data.error || "Failed to clear conversation");
            }

            // Clear messages
            messageContainer.innerHTML = "";

            // Add initial message back
            if (data.chat_history && data.chat_history.length > 0) {
              addMessage("assistant", data.chat_history[0].content);
            }
          } catch (error) {
            console.error("Error:", error);
            showError(error.message);
          }
        });

        // Mobile menu toggling
        menuToggle.addEventListener("click", function () {
          sidebar.classList.add("open");
        });

        mobileToggle.addEventListener("click", function () {
          sidebar.classList.remove("open");
        });

        // Adjust textarea height on window resize
        window.addEventListener("resize", function () {
          if (messageInput.value) {
            messageInput.style.height = "auto";
            messageInput.style.height = messageInput.scrollHeight + "px";
          }
        });
      });
    </script>
  </body>
</html>
